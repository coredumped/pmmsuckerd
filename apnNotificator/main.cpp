//
//  main.cpp
//  apnNotificator
//
//  BAsic notification service, the idea is to identify why we are no receiving errors from Apple Push Notification
//  service, what we think is that such notificaions arrive in a asynchronous fashion.
//
//  Created by Juan Guerrero on 4/21/12.
//  Copyright (c) 2012 fn(x) Software. All rights reserved.
//
#include <sys/stat.h>
#include <iostream>
#include "APNSNotificationThread.h"
#include "ThreadDispatcher.h"
#include "FetchedMailsCache.h"
#include "PendingNotificationStore.h"

#ifndef DEFAULT_CERTIFICATE_PATH
#define DEFAULT_CERTIFICATE_PATH "/Users/coredumped/Dropbox/MacOSXProjects/pmm_production.pem"
#endif

#ifndef DEFAULT_CERTIFICATE_KEY
#define DEFAULT_CERTIFICATE_KEY DEFAULT_CERTIFICATE_PATH
#endif

#ifndef IPOD_DEVICE_TOKEN
#define IPOD_DEVICE_TOKEN "4ab904318d30a0ecee730b369ea6b4acb9ab67c10023e5b497c25e035e353af5"
#endif

static const char *allTokens[] = {
	"15c7f94bd5cefad9370edfbe7d8b7b9f4fc5bb65d8dbd626908af925323aec6e",
	"a19feaacefa43013ef11d6f2037132b866590bd07525618375aac60e39eed9fd",
	"d8287832e4fac449d3864833dcd0380f1a1516cf578c52158985ae67d66856a1",
	"89af8be0e97911cb8c70f09b3dd45dd4b6f57eeda47227baeeede95f80441214",
	"c6b250fbdbbf07b463969e08bdf63c35c283995583194a28ea5f12171300bd12",
	"94fc91a5c6083192eead3eb182f96bf154c87e3933052d526db68c2fa0cf1cf4",
	"b509833bc17054f722d5808f312ee3128ab7e4eeca0416999011bc97fc3d3a8b",
	"c634cc9afa8d37fe494cdc97b9a896b5a5fa95178191b6c42431b6d6c998e0fd",
	"5779d93745624aa70d3f998495dc426c6fc49749b81bcb907b57c223e0ccafca",
	"dbc99f1deae8d9f88f5af781873f00c4f760b382b18f6b4cc8ed96c3f66c2710",
	"fe1691d32aa708fde2fd00378c4ebf51143f46099eaa480a99a3b7db335c9c73",
	"3a609eb61dc4a9dbfecc2e46c67619d64aacf95993005b7d89ed38abdbb7295a",
	"d9f8f9af162576f9ffb371c97ba7f9c8639b0da3b0670302eb444a20aad9b1dd",
	"cba18c474ef716a1eaec5689c63170fd65cd2ed166775d306440d41ff6fa0a78",
	"7f80c375458c595b58def3da0a6b19c92e0b6989e162697a21b24d966da957ec",
	"1a1a1479ba61a740e89d29fdbc9b482a3018106adb7e24484026b0f65d6e658a",
	"0f39374974b49d9aa68dd0f3a457c0e742da07709679542501c8c4c08b276ff9",
	"8328114e5d2e6b608327abafaecdd38e8291459d180fcbc417cd32e501b988a9",
	"209a1dce836916474a9b8221647560525521c29aed10c96174a9dcb60909715d",
	"c6d4f1716e062644b324c94ddc344cf0ab53dfd810ade482a486e9b6d52e392a",
	"3cdf0e77bf36191e633ac5086cf546c13bcb7155e99fe7f636d45673d79db68c",
	"f3f6f3b560ae1f129b76751bf90732ecfb4206f5f6db1a83c834619a9f441d76",
	"3ac9b1eabe62d16e264b44dbb6efa9d74cc18334cd7984f84920d3fb9f2cacf8",
	"9f6f5af25fe933fce08d3de7bf396d7e10f5bfeda269777781417ad6461b57df",
	"2e991a9d1a34c65c245150a63f982f60d7e72e4d082a9d4bdd7da75702c2cd35",
	"f5b7d0df0277617a952be33c4b5d6ad474c4cf64f2e8d92fb640a1b611f53338",
	"ca50dad5889ebc8687317c3b0f4065495751a824f313e0776470cf9b7fca8f42",
	"57aecf6276c74f1085b2f5dfe4474c3dc7688e7df35963c9c29eb4dd982060d6",
	"9092b3c330606a4ee3fc084fb2fc95aee05bb29220f47950518a2900f3c958b5",
	"4d1aa042542afbe59dbf09f8c2bce0477767123ae6863d0939a9182efc0451ad",
	"219429531d3647174734c1c999df1b6fa88ba625fe11b0109c2926fcba55fbd3",
	"f203dec1d6251fc91ade7a14bcb9bdfc7d36eef36b4eaea4b829c582e633d72f",
	"3b08d3c4cefc9fcfd62e510ab1467555e6c0efde92f82243095707269b76bc56",
	"a161722b9f7f0f414761556e008f93f13aec79155a814681d77908c5285e4418",
	"9e9fdd81a6b38458417d79d29cc0b91a741bb53f63087013b72dddecfd5dfc54",
	"c16e6d70886aeac1fb489c57094133d023a68d3105c6cff73ddd5a894c1129aa",
	"4194544e61949686e487d12b8884ed58c66e45219813cd8f2256292466a5ea00",
	"c16e6d70886aeac1fb489c57094133d023a68d3105c6cff73ddd5a894c1129aa",
	"3ae38be789bf8299cad1242af544f407594c3e0ebad3f96c544603440a89e085",
	"82aed966cffb87c2b238ebb011a8e9408e065fcd7fd6faa512b10b7de31352e4",
	"06860367958657851412695dc3d1e722a411effe2499e328c8a5c4dd9a9663a6",
	"86a3d1dde1259a277381d3b6951364867cdd8aaf69535b5d52a72a946b27be5e",
	"dbc8210fce278073dd666810aded4a9cea028375294434b61b57a066586fac10",
	"65ee1def230e4a87e6bded6607c2d2c10374e8882e26dbef8a2b9cd2dcc51134",
	"97c747aac8bf42326ef4f45b78f35e27f40bbaae1883eff7bda5048fb6db832f",
	"b694d57ad0a6ac995cf17f215716e5beeecf5325e3526e911c09ebd8b81836be",
	"d82badc6e8a3007ca15b4f1c4e0bacc7cc5f816a1db14c5a8c41eaed4cc4a9fa",
	"c5a2b719f627e6e4774cb9707bb4af4ff9f9ebae21e81a9ddf1301829b9bad76",
	"c31470d66a6bf5591455517cfd266c0493cddcfb14efaf7456c5c04f5539b14d",
	"1dea0e5204225fd73b6f4e956b051645a38623d10973b799727ee4552d049121",
	"e8443c51bb5b2a336a1e8f6d9b6ace46f853b836ffe94d49cfbb92c35853e592",
	"7ebcaedfac2311b549a39e649b70f2caf6ba1807f85353a4cf0e1f753c9a2c88",
	"e8c440251d11fcc3e4cb04d2e6a1f57b03cccee4ac210ea0bf0cb94aebb946da",
	"477199ca2c0eb10911bbb2951b08eda48595330bfc02ca06e3935710fa915141",
	"bfaba85e4dd508f778eb3a6cf00606579c28ecec5aea04088be335ea249685b8",
	"6bc17d02e2f4b6cb6bd1e979f245bc9640df4bd4948337f51a78ab5755168e9d",
	"d31623deb91b754d56275eb710c4730806a6011eea363665a800f112bb010073",
	"ed3c35c098aa7d5da50fc7e42f203780a74bacf7490e4540f04151b2b98ddcab",
	"17a8c2adefc6e744ad14bf2da02f058714ea7e22e973c51bd77b91b22c17e92f",
	"c18250014032f4187a513d774aa65d162cda2139ef6d2eb919ba5ab4017e42c8",
	"34936d034bbeb0560b69016577552a974cb76e171bb5ec6c399b5f85d6ffa8c4",
	"cbb62ce2110c6b76bf775fc28a40c9ec47618e4c2b17d897202e516e9a2bd2d4",
	"da383d96d4ec764eb3151ea6be1f434069fae42a69821214f84150f35b51ced9",
	"78bf32251d1d9d1f300ed77be9ea7fcf8e0387c056ff2c675e43a04fdda0b767",
	"7d9349d4b19a02f8b071245a865d35178c97b41701775835a5307f692ac4fe41",
	"7d9349d4b19a02f8b071245a865d35178c97b41701775835a5307f692ac4fe41",
	"1aa7bf31a400b0603db0b13cdf27b1bb8158bfa84a5a88af9e1420d942c1545e",
	"0f0b27da2b21330656ffa1c3df874009d8b527c1cb6819b1296372fee2e96952",
	"a4fb4c2a8c662d539f01bd5c06db05f2f15caa10e68aa2674afb717c11e78c5d",
	"2aeef71a59a8e9faa99c2cc5f513cf112eb77141765a0dee0f24ed52f479be0c",
	"49398aed71ad747b18cbcded02c9d99ee933d1ea0c041384c09c1c77c845a6d6",
	"abcbd4549f1c23b805199fbead5dd75ba7ef9df0dcec4b31aba4c25cbf8f2326",
	"5671ecccec1cd9a2691a8b5626bab1343687e807a864e4edcd7ae395a3345bc1",
	"a76866892291dba23a1fe0a86acf104a925240d7da13bf23ead35480139a67ca",
	"dd4db5dbfb94af070dfe60ac31623abb3067747f885cde290ac5146eb81df657",
	"d89579ccf54c8193e234d56066f6ba4b8bda6d82fa8ea1fe331c5e2f9105d812",
	"276e4e6a98d238568458b6d03d528f31ff12ed5d2a4feb0c768753b6125a618e",
	"412cfb43610f6c762f2665a8c748792ce777e619162940be7aa3bb0f1875b5ab",
	"b0c1ebbdfd804b3fdb24fde0acf0254243762b3000abd42bc2c07481f61eb7ad",
	"1c578cf94b9ce4d91216c35c5791cb9e811b6106fc3a985805f2cbbc0ec88244",
	"475da2ce000392f39256492c20b601d63f2801ba0ce5d9ad3a69829c2a757971",
	"b94d51b22f06537f309d48116cbfc115e4f848b4a768d3e47611393b45918921",
	"2d50b8222e59816e68814737feb7e1f0e265293e30670ada02568f011aac71d7",
	"8f533df802df109bbdde4af39a1dad49aad9d578990f7ff421a38ee56b7db467",
	"235002f37d452aa9a89144574e1d17e5c5fb214ce1d1cba7bc6dc5f7d79f376e",
	"046fe8acda2891a2d30df46ac27756f323695c8484041e6a86f6bb4bc494fab9",
	"d10b997cbfaac987e6c7cd6ffc721514831aaffc4ee7aa2031901b2b54c8866c",
	"2466bd9d90166b1f6b5f10b6020eba5e0c472376e56bd5d713332a0b1db16f68",
	"de3d60216595f7bd088adbafff40305e5ef4ecc31a9e83f5f9068bdecd4066f1",
	"b2d610c5db1788a6dcf3f44c5057bde015198544aa5aec76a083766162b5ad4e",
	"ebc0cd79e29a6d6afd65bc3388d22762055a46df5966e3fdc2fe3d8b1377ec41",
	"48a0e1c7f50372167a33e997bd8cd8a69eec71b0ca98431390eb18a69fba2346",
	"778cb99984344077d8297949b676b7daf6217f83632331558a837db67892fa0a",
	"686727bc6b56e9d2599616d730e1501a8c577a8937f79422af869ec2fdb086f7",
	"4a6f88aeaa481df7ca3ea143ebb64157c14cc171d8f87e018bf9a0c9a73c288f",
	"16198bf70c9b2627440270c65300a7caf555b487a452ed0e0afc5cd82dfbb780",
	"3cedab2007308e3ad93db6e8dc2d958c4a2701c51ad1e18decdf927986ebcc62",
	"6f4f29015a553e0984e65276df4b726a62ecd5c37ce66e918fd27cb1c2122c03",
	"15ecf820473d6786f16e00da151b5db3f5d9e126fbbc07bd0afc9ccd9111d3f4",
	"fc86d342996f8667c9264a3e9c3384e5a19c965b45d0f0c511902e7284ebe333",
	"dbc3a75fae11251c235aef73da9af81629a66445d6a1961fa8e5ce98eacd1bab",
	"9fa35c06a182346d68a505d0196949aab9aade341f4be37df36fbec1741ff6a2",
	"82085df83a166944af9e8a1a424c01f6c4295ad55801901019b4523fd4b17f8a",
	"6697c28fffd9db6d8b8b1ea3bd7d4d73e5a5711d1c868203a2fea2f4f9f1c502",
	"51fd1cfabdd543bfedcad35d4f70a981a63f6933b66e077f6e7ba612aad8469c",
	"14f3f0457035ff9acefa0c76b44148e0804f85fb3466354eb7a5da8d607e6c45",
	"b741a4276a9e4977e35a9b762ac82cf35228dfd8be5143bc865afe42e8baf428",
	"ce452db5649a84a85e9bfdde4831b3932c4371d1dbe8fbde611f93868a14409a",
	"4508ceb1f64ad9b23943933a62fd153bfc9805dcc6e78b01efbb2bde55997f87",
	"f39f1d98e4b23ab86956e648961cc7c5bd7bed97fc6466748416497e3023d7cb",
	"f599bebb5bbccda5acf3900fbf491d303968c5467fc8ae84a79d7b2b0a9fe210",
	"bcb069c6c33f93013ea4b049c5a1671f2479f1297de0ce0e3b02c326cd6d8ab9",
	"19713cbf8368096df4e09a5c62ecc0c0a878091844090bb8bcc735d216b0aaf0",
	"984c4cea3d37562e168740aa15a630eb5db18b0017c023b57ad4a666760ea8fc",
	"aa0b3600c9593c1f4b541c30174dd1172f9210a793d0f215aeb583f139316322",
	"ab10bb2073eddae371dc139539c820b18255e13f400a7ecf9eacfa6ca7901be0",
	"878956b4e0eda52de383ec3b99ab4b97b9fb1002d135b46c8f84a4662f1c278e",
	"037a3dea8e79f0d9abecfd09fb982e269ffc72f01815d96c589797151f396b64",
	"8e188f0e4394378caa80869c8e53959357b5d73c6312d17a63ddc421d6089c58",
	"8e188f0e4394378caa80869c8e53959357b5d73c6312d17a63ddc421d6089c58",
	"fa8a5eb0890f20be4ebfdd8d31282d2f4d72b64e95daba6627016cc7834943bd",
	"065fc6332fad3c3ff6b56a3e27dab48419c1fc2fc6901bc79d3c07898f3a0ee9",
	"31a12a044981dd8c388221a08ce58fb90e617a6a9b62484abb1ae88d000005bf",
	"5b0c5956c86badf3553ae7bdae68987b58ee29d6f7742ec3add850f4b2c62fef",
	"5769eb0a3c7ae08dd05d420bb0c1c2b8620628d509d52b07b268b9146b696489",
	"8d23905b0436715db0268b1e29edab846092b06bbcd83e48e19443f7e136dad4",
	"c91511a9a9ba4875a5f20d59db8e2f638d738b09d96a66653932669d0c41818d",
	"2c819a298dc8416579fc7e7f8b2d0aacff8a13af1908667a92dbf27eb83fc0fb",
	"d06783126fe8b70aa027097adb50e967c0b3cd13d05fb9325001fdcda0d2b6a2",
	"525b7d1fc77b2f06826e0d2b26ad2583596712ec571b23a3226a9f91ea2a26ef",
	"f9495df656cb9a2645ea005a500e60636075a0169a265665ca53c405a6ee5c03",
	"f9495df656cb9a2645ea005a500e60636075a0169a265665ca53c405a6ee5c03",
	"60de518c91f1b9bf14491a661eaf1eb25a8ab9ae4ae6f9f88d3959fbcaf3a60f",
	"1ed5c20f7d07f3de4fd43b1869f6a96d1ababc36e2fbe4edd706e6af24776a01",
	"e9e3858c6dd6304c846f30df8a0cc7b7d1e0cf2544194224a750384362e62577",
	"a1d3eb8a5e943137fc223ad91d75b1a3cc90bd9bdd7552705edff0988cae6837",
	"206a5aa17265c8e04c3b712a83c33168e3d394ea8a5ba20ceeb75f5eb96737a0",
	"b35da1e48452749a157c42aba441bd7f5c50aa673582be2c623d789ff4ac8b78",
	"655527d1010c3491f7ac06b2d7077062baae986ebcf7a1f200703616abd412b5",
	"655527d1010c3491f7ac06b2d7077062baae986ebcf7a1f200703616abd412b5",
	"3a30d0143d5d1ce26db4d465e60095a851b7360b2a273f6d67bf58b24cf84ce3",
	"732e0531f1d5b17274355ce651059d087ffc6040e54e92e980934de8e8befabb",
	"a162524da4e21a1c5adf0e8d33933e37fa5986865e5e5ea1b03b1fb18f42e913",
	"2aa8be79bc7ba93b3e9ec0517927f5ca162ff03c2b684cf7b904c714f9b8680f",
	"acc6854b0bd9fb79255c24c60c0413dc3f93a66aded5699f8da1ed3881f4d9f1",
	"a62526e68658922217a761ae5de7b2828b7ca0eeddfbb79b9f50bdb0fd4d8411",
	"a41cb283490f3219feae2df3d8564e0a81aa0a5cba2acb8e0083efc5a99f7906",
	"a41cb283490f3219feae2df3d8564e0a81aa0a5cba2acb8e0083efc5a99f7906",
	"19c6a4d8011fba752498b4afc2df95be3cd5a049936e0a144edf5f2b1da1195d",
	"931392125f3d709b5ceea6609db33dd3219885e55532d1a2d012b42b6616b8fa",
	"fea1d17347a9fb76b40b502e684d228d72ac6b4c32178019c37eb8803b6f195c",
	"8afa323a1b335e2f21cf38b612335af9dabde17d0c6f82034ce2591e05e497b5",
	"1f7cd71d1c83d634f97eacb9b7f8f011b38ce59fcadbc79edeed555e5300896d",
	"e2a5bf4b0fd34aba812726225b7672ec630eb8ef9d87103388b6aacfd9230e1c",
	"79df8bda38daf10e166220635413158125569a9db96586b45960f21137f29355",
	"91362beb36ebfe8b71f2fced089310e0e0c36d8f99d2ac9a2eae1ae7074a6639",
	"c99158eae17729105ac73a518a21eccc8a3de5a031a10a595daf2ec512f75b21",
	"40be904b2658448b7c7f10f71725ae15afba10f566c1dbbdf92a51b7c1a4bc60",
	"40be904b2658448b7c7f10f71725ae15afba10f566c1dbbdf92a51b7c1a4bc60",
	"686c8b58d7f5874048b11829d0fbc00a3a17a707697ee6f62c3adfc659050590",
	"a9570fafe1722e81ad207b23f1ac50c11dbd5167c84dc5adb3a095b66cd1b2cb",
	"e4f4821e76e528234676f5720605f911ed9e822cfbf3c4f7bd2eadefcde22520",
	"72ab11fe23c286d40ff15c33bbee5eea821ced5157cf808e00b4d82ae628c057",
	"94692d0d5fb926507fd79fec07a0076912a78721f1594b3526e0c6bfbe421af6",
	"2cba1ce764d9d34117bcb38e3f02dbde83edba7c9aee0afd9da17f1008b0ad8b",
	"d7cc395cb7d2cbd8d153df03a3d5fb2072c51191554faf5b24dc24e5462bba61",
	"1f98246ee93698956889c17b8471e751ecb722dded7b59056e3f76166556ac72",
	"4662e1c1299e4230ace6b3dac721c475beb65ee7d0e43888d487dac1627effbb",
	"76d5bb7d9792739214aa674a0bd9d29fecc18a2173044415859201b08243e1ef",
	"ed95e42b1f4a4ac91f15806d32621ae0355e0bf3c07a109f82d3011058828999",
	"12584f7b667d13e8ad281d55fbffd16914110fee9dbc5cd1dc9faea823c3a40c",
	"d1fc17762ba52a71ef80e0094a0d08a91a2abafef35b52a9bc00ce6e47f7c273",
	"fcd44c1a52525db8c8394d7e6c27db2fb6211887eb568ee3b79c0362a214bb46",
	"472ba9c4938d0d7945b0540a07d0576fc195a85bf92202852dbc2d4eee07736c",
	"ea4316a1c1abcd47bb178355c3db0d84cd351ac9220ae6b6a8fe4792899fee99",
	"7725382ef48b4cfad50803516b6e4440eac4deef66f7e7803b7dc7f2f0411734",
	"6c352cc54e5e2b36abd73564b32faaf829de281790e20f9deb2372a19c039faa",
	"f6459f2806200ff0244d1ee0ff7a64e8130f10104912d2b25b8f0b8a2cd4d7be",
	"9cb5faacc4aaa11034a3e9aaff0f8bdf9d865b38f20e5593f241c286aee01f49",
	"d375a447979b3bbbc31bff6a3130ce0a63b0ada70b2096a45536fcdefac9709f",
	"69b4ca9dd80dbb608289e7b21f798377e30dbbb07719d8916953c5066385d26f",
	"798a913441ffcd9924424dbb69efd69cb3dfcdb5d839f556a4b58207bb8e4f68",
	"8dbbeb19b9c436ff6d570229820d58a9ee85023f05577e2718d819e44cb7882c",
	"8f4f17c4803c11cdfacb0119831918da14d8670e2f15f37f7ed553d1c31cd8c2",
	"1bee6bebd415dd71a255961378efca8144863482da8791c3c2a8202644f3fff5",
	"8ab25187a04f7198ea6f16001c41bd603642b5274c84551b129a1f2dbde5f574",
	"c7b2ee47d6074bb3daf6d8bad12ed9f864631bdbf81b57028a773108938b77e2",
	"123698e1aa83eda4274ffe0d22f5edfdb878b3459a4350ced9f2def20d7ffb4f",
	"7ce4a22d7fdb53a22607d26d89831d3c29a53f67548999b8fe99faa3f0200e01",
	"3198740291e62c48945fa75814160cae93dbb45380c992133d5c6cf84167ed22",
	"8c3f3d5e6f2714f72d4b1cd71a4bcf3a1452406eedcdd3eeb8a95e21f19757bf",
	"1bdb5e8dc4e82b48d8c49edc3a270a041f2771bd5e0df1ba8714b31043d02e43",
	"10a3b8aa8454899cb01204befdf9b4490c1b34501c62a75005ecef15a2d75e5a",
	"8fd35e5e02b3a1b62dd203edfa74f85fe6e0f97f1f533338dbefc1ba6c460b56",
	"ec440c2ef3c4588bb4e6ca0759359e9be33271427025cbe197642dd87e9af667",
	"8a59cd1c3a4331f3d518df2b01bd5e274c9022dc981fdb25c99c354cd9b4d9b4",
	"38efe48c156127c69772415e85840c38fe7be85d46dab70d1df0095a2363d0eb",
	"3e6504a37cdd2c6fb62435afa9e07bda2e17b88b3b5ab93abade7e1cfde213df",
	"3e6504a37cdd2c6fb62435afa9e07bda2e17b88b3b5ab93abade7e1cfde213df",
	"20212a7667e9689c6910fcb876840749c0f4a9f4205d55db333f13880a6f0bf2",
	"b0a3bb0d653feb8f84b6db5d7f673f3f612845002c6aaf30a70766a4bce9eeba",
	"6098105893f53715442e6034bc258d836e79b8368bf527a69cb3ea3c2880ab73",
	"84a0a94243a12de6668f79d25f14c8c694ea2ff6c8a6299f5209e68ea5e2133a",
	"ff977e58e195e274d00be7b49a437e91f16224648542f1e7519c157a13fc62d3",
	"97f71f374e038cb53100e4f0850d7058881e5c7af5743dee0b2cced92064df9a",
	"b6a699c6ed0b1fa7ac86eb3d1bb9e25edfe1e7aa2a093d394d794f968be5f53d",
	"4ab904318d30a0ecee730b369ea6b4acb9ab67c10023e5b497c25e035e353af5",
	"196be3299e6f6d23ca9c594faaf48c3ee1f27d264e262226094c38d44a2f36de",
	"0a07dc56460df8f80c1ad74c05ae9fb4de93f23cc8bea711216b418c06c401c9",
	"70b89a39087fc6b9df5a0bf3c1a630dd953a5b623a211dcae7d0122eedcb2c46",
	"0e8cb4ca9cf30be919a23069726152338b9162912da1f8b81c7aaaf4079c8d03",
	"e38a83150d4ad954e5d386a64a27162a2e6f287b0ac4a8c7a00a8c21d723f105",
	"339bff28687a33f0522c4cae227dc3bd2505fbe7634d36a2e413964eb0e56d42",
	"d55162a8a40c802d1d45f59e0cd341a933f76e62286a1134956e00aafb6a2dbd",
	"8d07e51904d81b144abd1a7ce9db84e36a73362db05af2af5b413e0080966c54",
	"1206759b61c666bd3606bf76c8193f8f59f931aea16f3113d100fc3bfb77b066",
	"6080f7b83d1eccd42dd6834d85bc17ffade9a1f27b5e14e69ff7c2983e738638",
	"02c3d39e67f442e979536923b0da5957d247b5272775aeff460107f1397e2e6f",
	"fcab983a0bdeeff35c5385e8a687c075e58a7df6cae22915bc9e955b44b58b46",
	"26cfeee43628cd90c7c3a2d5c2f3310f633df87f9482f3946bda42d9d6c43516",
	"b4a383d815ac8e492f498b3d2acb7314283658b1020e964664e316f7e5dfb94a",
	"2baec9cc019962e7da70bc8d83b3d695e72b4d47a0deb2dca70937583eebdcee",
	"b27d7122f458f078fc73458ceaaf5d0abfc0a2d7f30c14272b670b31fe30bfc4",
	"b8377c6c6d447785a86d049db8d2d43dd095500f90ffcf71fa168cf10cc08604",
	"d7fb5825f5a7f23799634ed0b15a7badb3c8a6bd0a0044091e29aa04053ad287",
	"c0805cbb43624836aa5a90966749a6acd636206ed76c13445199c96b8d223f8a",
	"6bca1fad7350724b1e47032adc1eb67ae122fbd98149655e0b5b031084df2ef4",
	"7ba177d257bce4f62e4fb56e9b0903938ae9df3eca72769a273bce8b880d6d10",
	"05b77348a0a23732c1634cb32538fcdc114e40a75bdb907eb2078d59a31ef67f",
	"c31470d66a6bf5591455517cfd266c0493cddcfb14efaf7456c5c04f5539b14d",
	"4153346bdab685d192691f2cf36566c8ae9779faad6ec969b7ddd5fb1ac4ecb8",
	"bc6d7b5cc62c9b2837d72afe2edb5abab405c87d03538080bf247c3b01cd6d99",
	"14e51b06bfb62d5d7e675a8a3cd197145bb3e542a0c033a56470d7fb8506f829",
	"35cdfcbca405c1abe2731d398d6f769e28288f7810d516471f071842d78f942f",
	"d7d05f5e29dad41e8b8cf83748b90c31f7e9340ce586fa4c3506a9cf736dcf4a",
	"901e917d16d276157ce031a7b8604e700ec91206ab5447d254cee009ab0c034d",
	"b1e99dd738bf22174da90ef3c0999292c74bf2a9634cfa9c2b26a50f4d0352c0",
	"227899601571ad0ced1edfa478071a7fc7118e9bc39f904f95f29e9e0bd0fb0c",
	"c0805cbb43624836aa5a90966749a6acd636206ed76c13445199c96b8d223f8a",
	"eab92764a3fa17aeb41d0f5e44fe6369b08f036998a530700dae06d534ff4636",
	"a726cd054b3fb57b0b07a5cca76b3be31fced39f68b141f2d4c32711752b3ee0",
	"50a3cecced095676344f9182adc0f094004718530f491e610841c8aace704e38",
	"4c8708c423955cfd8ee07e67d5dec9c6a28fa1e10835b48e2cdcc3ef9ec1175c",
	"8d69e37e1509eb67eb2d88a6428a0314d5ae02af0638d78fef6d7c4041956315",
	"5c1b322c58dd4eb4036983ec6f3bf7b9af75cea4deb4b8c51440e5891cdb82db",
	"2523330fb0fb112bb96b9799b7246d3eaf6dada57fea227e9dcfac3e6aca596a",
	"f27d9cee95632ef2f64433c41a7acff033e29c9d0a21770250ba52a87fdc5e2f",
	"260653d2ef6073a8341233e8092b04bd1a7cd7565c82a8ba99533886505ba252",
	"260653d2ef6073a8341233e8092b04bd1a7cd7565c82a8ba99533886505ba252",
	"c5222cc5f2d8189b72d298ed9139ce2e56d40fbfc52b4b1aef758b49c791cced",
	"fc9bbed9c9fc06bb5a3aa7b04cdef7168990e8a46d1b012d64a2d018b5479d27",
	"74bb193834715e11db24cdc979d2fb744cb75745c2e1c9d94850ef56fe4477ce",
	"10965ae7fbf1abac0f56c1a70218e57cc4340e4d2d1d20c37ba22adc8f790eb0",
	"bde3a60cb24e9b9b1d66f8047e3fc20e1604ad376926f454768ebd5ef68323a2",
	"eb716a5e6dbfd8f778d65d41ffb0d8dd46fc5b8eb2f98fcfee76de0bc33cea21",
	"69d45ae899950c3781788f49f4796cc1b61ab25005ee5e69f5013ce8afd8a46e",
	"adc667366a4c2dca75def1e2f37c86979a4d54cee43ee2d6b5d91c877639b426",
	"6a39f2ab27d9bdd6efbaae6afe4e1c50706209209424d4838d2701ab685f050e",
	"289b4b4e6b9c2568ea2e8ceab87a332f8b1cfadb76dfe133cd04dfc05200804c",
	"fc4b535586ccd31ef08bdf3d0c31f4b392b4cb0367c10853f274d2def7ff0442",
	"dfbe71ba6aefe6f4de25bee1cf04dfee1810299424d8d3bdd16ce8fafb7bf462",
	"fbb79740b750bf855f2162a0151e4f962535cc7a9b71fb7cfbb0aee4320477e5",
	"7cf5c2f7daa6c45ec79d5f6b82cc1af24c858f45e428d510140c2f11f304996c",
	"c52de1e4206027cb89af8a1e417cdaea37d170b7a7d3236bb6b6bcc67a1d6d16",
	"e95e283b00ce9c4c9cd7d6930499353a100889ef31a52932f705918463aaa3b7",
	"6a1b72f5875b5e096896ec91bd8e38a861f42427b3687ecca88349dc4ad1256e",
	"d1ebdceccee881ae02d9164438ea136113d3c97c5a4cb0c6a7ea787db8e6c0b7",
	"c91511a9a9ba4875a5f20d59db8e2f638d738b09d96a66653932669d0c41818d",
	"eef34f7cbbd49ca59c0c1d59c5fe89a0364fd5a9eaad7d46b5178520f10bd47c",
	"33c792176721b601c6a2b5d7e4296670dfca7e97f7820332119e2cd79fde728f",
	"e4f68de486779b698ac9ccaf34b55d24dba6aff6b1125836d9c44cc47d27e390",
	"85a5bb808565b502345a326b2392beb9a6a41ba9ae264d9e4565996638221cf5",
	"6b827bc90f78575eb6076c3cbe3ee58ac6b8ea66ecefe7958e1a936081591c19",
	"955e9786a87df431399c36ee3db900ed06c850ae24f1fc9329a73e0811fb9c07",
	"44183377692db63f21074a96b55f0ae5379a6fbb7a8ae0bfcdc918ed5e3473ed",
	"f94775383b904187ba1c6d1f3281559cc5eb909d8b4f54a960f0d4aa7a9ffdb0",
	"3700f8764ee8aa7b1e83ba45ca20b0c00b9e29a63ad3f2ed3d10afa6f293b711",
	"b4a383d815ac8e492f498b3d2acb7314283658b1020e964664e316f7e5dfb94a",
	"a4e57bf8d9141e22187f429f7cd11f19f0bc448afba53c2069399efd44f272b7",
	"d088d5b05c006b98b4e65bab87ccf9887ed7ea39d9b0e960f0a7763731716fb2",
	"01d04fc10755c8a2b845085e39d40f7af1ab4454873ad7faa49282e32988c4d9",
	"589d89f0d183bf4108ef0ec1af523ab33013e3e281c9ebd3cec2c1630231f222",
	"0b37ce7a0ecfe42de50dbc6ba67cc87df8fd53ab44a46fa3499262f5089a5076",
	"a97f586818a9e154c284c084d5eec4089ab7caa2379e921ed6f8b2c02668bb96",
	"91e19348762cd84ea6e3358a3e83b363fead37166259d6695913a88c7a4cd4fe",
	"8a1633a306326f02cc903513e1de611cb11c51fc3d881415d81fe1de026fa9f4",
	"0e59cb44863dd6dbc515034461a13f76e9c7f8c7054887b508d893dfc43f8e29",
	"aabfca4f219a2c97ad7d3f8b93143ba062ed96ebe136d73ac8d7996b39551125",
	"518c1039641e7742eea0bbc97cbd67bf5c65dd6ae0396a0a25824012166ece35",
	"26800241626e1756df418a97adbd3399741dcc72b0983fe4bdcc4f897b99db9e",
	"3b89bddf4951e13df51f93b720be5daee8cc49794fbadbee9a7eb890f8bdf642",
	"29a2e55ee767b1ac7eeb89c68ecc99fa829a8117099878e2f70b762357398d86",
	"1f617b3c47a8bb8a057ccdc21142e774488751264718dc4dd9a4f24dfaf8b22f",
	"48a0e1c7f50372167a33e997bd8cd8a69eec71b0ca98431390eb18a69fba2346",
	"c890b068d5ba88780dc88d0e8ead7be216284f6c5c1b3e423a5bf43630af2c11",
	"16198bf70c9b2627440270c65300a7caf555b487a452ed0e0afc5cd82dfbb780",
	"75c08a32ee8c9c1c716a1f38161f142929c04a24ae32df2c82f4b42b18c4fba6",
	"86be104d02538870c97bbd09eabad0857707de54520b3d319158ef57328af66c",
};


int main(int argc, const char * argv[])
{
	pmm::SharedQueue<pmm::NotificationPayload> notificationQueue;
	std::string certificate = DEFAULT_CERTIFICATE_PATH;
	std::string privateKey = DEFAULT_CERTIFICATE_KEY;
	std::string ipodDevToken = IPOD_DEVICE_TOKEN;
	for (int i = 1; i < argc; i++) {
		certificate = argv[i];
		privateKey = argv[i];
	}
	pmm::Log.open("/tmp/apnNotifier.log");
	pmm::APNSLog.open("/tmp/apns-notifier.log");
	pmm::APNSLog.setTag("APNS Notifier");
	pmm::CacheLog.open("/tmp/mail-cache.log");
	pmm::CacheLog.setTag("MailCache");
	SSL_library_init();
	SSL_load_error_strings();
	struct stat st;
	if (stat(certificate.c_str(), &st) != 0) {
		std::cout << "Unable to find SSL certificate." << std::endl;
		return 1;
	}
	pmm::APNSNotificationThread apnsNotifier;
	apnsNotifier.setCertPath(certificate);
	apnsNotifier.setKeyPath(certificate);
	apnsNotifier.useForProduction();
	apnsNotifier.notificationQueue = &notificationQueue;

	pmm::APNSNotificationThread apnsNotifier1;
	apnsNotifier1.setCertPath(certificate);
	apnsNotifier1.setKeyPath(certificate);
	apnsNotifier1.useForProduction();
	apnsNotifier1.notificationQueue = &notificationQueue;

	pmm::APNSNotificationThread apnsNotifier2;
	apnsNotifier2.setCertPath(certificate);
	apnsNotifier2.setKeyPath(certificate);
	apnsNotifier2.useForProduction();
	apnsNotifier2.notificationQueue = &notificationQueue;

	pmm::APNSNotificationThread apnsNotifier3;
	apnsNotifier3.setCertPath(certificate);
	apnsNotifier3.setKeyPath(certificate);
	apnsNotifier3.useForProduction();
	apnsNotifier3.notificationQueue = &notificationQueue;

	
	pmm::APNSLog << "Starting thread..." << pmm::NL;
	pmm::ThreadDispatcher::start(apnsNotifier);
	pmm::ThreadDispatcher::start(apnsNotifier1);
	//pmm::ThreadDispatcher::start(apnsNotifier2);
	//pmm::ThreadDispatcher::start(apnsNotifier3);
	sleep(5);
	while (true) {
		/*std::cerr << "A valid notification sent" << std::endl;
		pmm::NotificationPayload np(ipodDevToken, "Hola Francisco :-)");
		np.isSystemNotification = true;
		notificationQueue.add(np);
		//Notification added to queue
		sleep(10);
		pmm::NotificationPayload np2("Device token invalido :-(", ipodDevToken);
		np2.isSystemNotification = true;
		std::cerr << "Invalid notification sent" << std::endl;
		notificationQueue.add(np2);
		sleep(10);
		std::cerr << "Another valid notification sent" << std::endl;
		notificationQueue.add(np);		
		std::cerr << "Waiting..." << std::endl;
		sleep(300);
		pmm::PendingNotificationStore::eraseOldPayloads();*/
		for(int i = 116; i < 298; i++){
			if(i == 115) continue;
			std::cout << "Sending notification to id=" << i << " token=" << allTokens[i] << std::endl;
			pmm::NotificationPayload np(allTokens[i], "PushMeMail\nService has been restored, you should be able to log in to app as of now.");
			np.isSystemNotification = true;
			notificationQueue.add(np);
			sleep(1);
		}
		break;
	}
	while (notificationQueue.size() > 0) {
		sleep(1);
	}
	sleep(2);
	return 0;
}

